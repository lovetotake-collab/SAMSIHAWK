<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚¼ì‹œí™•ë§¤ë§¤ í™•ì¥íŒ v1 (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ì—°ë™)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
        }
        input[type="text"], input[type="number"], select {
            border: 2px solid #e5e7eb;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s;
        }
        select {
            cursor: pointer;
            background-color: white;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .input-gray { background: #f3f4f6; border-color: #9ca3af; }
        .input-chart { background: #e0e7ff; border-color: #818cf8; }
        .input-high { background: #fee2e2; border-color: #fca5a5; }
        .input-low { background: #dbeafe; border-color: #93c5fd; }
        .input-bounce { background: #d1fae5; border-color: #6ee7b7; }
        .input-date { background: #fef3c7; border-color: #fbbf24; }
        
        .btn-calculate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        .btn-calculate:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-reset {
            background: #6b7280;
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-reset:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }
        
        .btn-google {
            background: #4285f4;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-google:hover {
            background: #357ae8;
        }
        .btn-google:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .btn-backup {
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-backup:hover:not(:disabled) {
            background: #059669;
        }
        .btn-backup:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .btn-load {
            background: #f59e0b;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-load:hover:not(:disabled) {
            background: #d97706;
        }
        .btn-load:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .sync-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        .sync-status.connected {
            background: #d1fae5;
            color: #065f46;
        }
        .sync-status.disconnected {
            background: #fee2e2;
            color: #991b1b;
        }
        .sync-status.syncing {
            background: #fef3c7;
            color: #92400e;
        }
        
        .buy-box {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid;
            transition: all 0.2s;
        }
        .buy-box:hover {
            transform: translateX(4px);
        }
        .buy-40 { background: #fce7f3; border-color: #f472b6; }
        .buy-50 { background: #dbeafe; border-color: #60a5fa; }
        .buy-60 { background: #fef9c3; border-color: #facc15; }
        .buy-70 { background: #fee2e2; border-color: #f87171; }
        
        .delete-btn {
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .delete-btn:hover {
            background: #dc2626;
        }
        
        .drag-handle {
            cursor: move;
            color: #9ca3af;
            padding: 0 8px;
            user-select: none;
        }
        .drag-handle:hover {
            color: #667eea;
        }
        
        .dragging {
            opacity: 0.5;
            background: #f3f4f6;
        }
        
        table {
            border-collapse: collapse;
        }
        table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        table tr:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .d-day-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
        }
        .d-day-badge.warning {
            background: #fbbf24;
            color: #78350f;
        }
        .d-day-badge.danger {
            background: #ef4444;
            color: white;
        }
        
        .rise-rate-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 4px;
        }
        
        .chart-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 4px;
        }
        .chart-badge.minute {
            background: #fbbf24;
            color: #78350f;
        }
        .chart-badge.daily {
            background: #60a5fa;
            color: #1e3a8a;
        }
        
        .stock-list-section {
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .minute-section {
            background: #fef3c7;
            border: 2px solid #fbbf24;
        }
        .daily-section {
            background: #dbeafe;
            border: 2px solid #60a5fa;
        }
        
        @media (max-width: 768px) {
            .grid.grid-cols-3 {
                grid-template-columns: 1fr;
            }
            .grid.grid-cols-6 {
                grid-template-columns: repeat(2, 1fr);
            }
            table {
                font-size: 10px;
            }
            table th, table td {
                padding: 6px 2px !important;
            }
            .buy-box {
                padding: 12px;
            }
            .d-day-badge {
                font-size: 9px;
                padding: 1px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="max-w-7xl mx-auto">
        <!-- í—¤ë” -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                        ğŸ“Š ì‚¼ì‹œí™•ë§¤ë§¤ í™•ì¥íŒ v1
                    </h1>
                    <p class="text-gray-600 mt-2">ì²« ë°˜ë“±ì„ ë…¸ë¦¬ëŠ” ë¶„í• ë§¤ìˆ˜ ì „ëµ (êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë™ê¸°í™”)</p>
                </div>
                <div class="flex flex-col items-end gap-2">
                    <div class="flex gap-2">
                        <button id="backupBtn" class="btn-backup" onclick="manualBackup()" disabled>
                            <span>ğŸ’¾</span>
                            <span>ë°±ì—…</span>
                        </button>
                        <button id="loadBtn" class="btn-load" onclick="manualLoad()" disabled>
                            <span>ğŸ“¥</span>
                            <span>ë¡œë“œ</span>
                        </button>
                        <button id="googleSignInBtn" class="btn-google" onclick="handleAuthClick()">
                            <svg width="18" height="18" viewBox="0 0 18 18">
                                <path fill="#fff" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                                <path fill="#fff" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                                <path fill="#fff" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                                <path fill="#fff" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                            </svg>
                            <span id="googleBtnText">êµ¬ê¸€ ë¡œê·¸ì¸</span>
                        </button>
                    </div>
                    <div id="syncStatus" class="sync-status disconnected">
                        <span>â—</span>
                        <span id="statusText">ì—°ê²° ì•ˆë¨</span>
                    </div>
                    <div id="lastSyncTime" class="text-xs text-gray-500"></div>
                </div>
            </div>
        </div>

        <!-- API í‚¤ ì„¤ì • ì•ˆë‚´ -->
        <div class="card bg-blue-50 border-2 border-blue-200">
            <h3 class="font-bold text-blue-900 mb-2">ğŸ”§ ì´ˆê¸° ì„¤ì • í•„ìš”</h3>
            <p class="text-sm text-blue-800 mb-2">
                êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë™ê¸°í™”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ Google Cloud Consoleì—ì„œ í´ë¼ì´ì–¸íŠ¸ IDë¥¼ ë°œê¸‰ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.
            </p>
            <details class="text-sm text-blue-700">
                <summary class="cursor-pointer font-semibold mb-2">ì„¤ì • ë°©ë²• ë³´ê¸°</summary>
                <ol class="list-decimal ml-5 space-y-1">
                    <li>Google Cloud Console (console.cloud.google.com) ì ‘ì†</li>
                    <li>ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</li>
                    <li>Google Drive API í™œì„±í™”</li>
                    <li>OAuth 2.0 í´ë¼ì´ì–¸íŠ¸ ID ìƒì„± (ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜)</li>
                    <li>ì•„ë˜ ì½”ë“œì—ì„œ YOUR_CLIENT_IDë¥¼ ë°œê¸‰ë°›ì€ IDë¡œ êµì²´</li>
                </ol>
            </details>
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ“ ì¢…ëª© ì •ë³´ ì…ë ¥</h2>
            <div class="grid grid-cols-6 gap-3">
                <div>
                    <label class="block text-sm font-semibold mb-2 text-indigo-600">ì°¨íŠ¸</label>
                    <select id="chartType" class="input-chart">
                        <option value="minute">ë¶„ë´‰</option>
                        <option value="daily">ì¼ë´‰</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-gray-600">ì¢…ëª©ëª…</label>
                    <input type="text" id="stockName" placeholder="" class="input-gray">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-amber-600">ê³ ì ì¼</label>
                    <input type="text" id="highDate" placeholder="" class="input-date" maxlength="6" oninput="formatDateInput(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-red-600">ê³ ì  (ì›)</label>
                    <input type="text" id="highPrice" placeholder="" class="input-high" oninput="formatInput(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-blue-600">ì €ì  (ì›)</label>
                    <input type="text" id="lowPrice" placeholder="" class="input-low" oninput="formatInput(this)">
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2 text-green-600">ë°˜ë“±ì €ì  (ì›) <span class="text-xs text-gray-400">ì„ íƒ</span></label>
                    <input type="text" id="bouncePrice" placeholder="ì„ íƒì‚¬í•­" class="input-bounce" oninput="formatInput(this)">
                </div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-3">
                <button class="btn-calculate" onclick="calculate()">
                    âœ… ê³„ì‚°í•˜ê¸°
                </button>
                <button class="btn-calculate" onclick="addToList()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    ğŸ’¾ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
                </button>
                <button class="btn-reset" onclick="resetInputs()">
                    ğŸ”„ ì…ë ¥ ì´ˆê¸°í™”
                </button>
            </div>
            <div class="mt-3 text-sm text-gray-600 bg-purple-50 p-3 rounded-lg border border-purple-200">
                ğŸ’¡ <strong>íŒ:</strong> ê³ ì , ì €ì ë§Œ ì…ë ¥í•´ë„ ë§¤ìˆ˜ íƒ€ì ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë°˜ë“±ì´ ë‚˜ì˜¤ë©´ ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ì—¬ ë§¤ë„ íƒ€ì ì„ í™•ì¸í•˜ì„¸ìš”.
            </div>
        </div>

        <!-- ì¢…ëª©ë¦¬ìŠ¤íŠ¸ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ“‹ ì¢…ëª©ë¦¬ìŠ¤íŠ¸</h2>
            <p class="text-sm text-gray-500 mb-3">ì¢…ëª©ì„ í´ë¦­í•˜ì—¬ ìƒì„¸ íƒ€ì ì„ í™•ì¸í•˜ì„¸ìš”</p>
            
            <!-- ë¶„ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸ -->
            <div class="stock-list-section minute-section">
                <h3 class="text-lg font-bold mb-3 text-amber-900 flex items-center gap-2">
                    âš¡ ë¶„ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸
                    <span class="text-sm font-normal text-amber-700">(ë‹¨ê¸° ë§¤ë§¤)</span>
                </h3>
                <div id="minuteStockList"></div>
            </div>
            
            <!-- ì¼ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸ -->
            <div class="stock-list-section daily-section">
                <h3 class="text-lg font-bold mb-3 text-blue-900 flex items-center gap-2">
                    ğŸ“ˆ ì¼ë´‰ ì¢…ëª©ë¦¬ìŠ¤íŠ¸
                    <span class="text-sm font-normal text-blue-700">(ì¤‘ì¥ê¸° ë§¤ë§¤)</span>
                </h3>
                <div id="dailyStockList"></div>
            </div>
        </div>

        <!-- ë§¤ìˆ˜/ë§¤ë„ íƒ€ì  -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
            <!-- ë§¤ìˆ˜ íƒ€ì  -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ¯ ë§¤ìˆ˜ íƒ€ì </h2>
                <p class="text-sm text-gray-500 mb-3">í”¼ë³´ë‚˜ì¹˜ ê¸°ì¤€ ë¶„í• ë§¤ìˆ˜ ì§€ì </p>
                <div id="buyPoints"></div>
            </div>

            <!-- ë§¤ë„ íƒ€ì  -->
            <div class="card">
                <h2 class="text-2xl font-bold mb-4 text-gray-700" id="sellTitle">ğŸ’° ë§¤ë„ íƒ€ì </h2>
                <p class="text-sm text-gray-500 mb-3">ë°˜ë“±ì €ì  ê¸°ì¤€ ë§¤ë„ ì§€ì </p>
                <div id="sellPoints">
                    <div class="text-center text-gray-500 py-8">
                        ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ë©´<br>ë§¤ë„ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤
                    </div>
                </div>
            </div>
        </div>

        <!-- ë§¤ë§¤ ì „ëµ -->
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">ğŸ’¡ ë§¤ë§¤ ì „ëµ</h2>
            <div class="text-sm text-gray-700 space-y-2 bg-amber-50 p-4 rounded-lg border-2 border-amber-200">
                <p><strong>â€¢ ë§¤ìˆ˜:</strong> ê³ ì ì—ì„œ 40%, 50%, 60%, 70% í•˜ë½ ì‹œì ì—ì„œ ë¶„í•  ë§¤ìˆ˜ ëŒ€ê¸°</p>
                <p><strong>â€¢ ë§¤ë„:</strong> ë°˜ë“±ì €ì ì—ì„œ 25%, 33%, 50%, 66% ìƒìŠ¹ ì§€ì ì—ì„œ ë¶„í•  ë§¤ë„</p>
                <p><strong>â€¢ ìƒí™©ë³„ ë§¤ë„ ì „ëµ:</strong></p>
                <p class="ml-4">- 40%ì—ì„œ ë§¤ìˆ˜: ìµœëŒ€ â†’ 50% ì´ìƒ ë°˜ë“±ì—ì„œ ë§¤ë„</p>
                <p class="ml-4">- 50%ì—ì„œ ë§¤ìˆ˜: ìµœëŒ€ â†’ 50% ì´ìƒ ë°˜ë“±ì—ì„œ ë§¤ë„</p>
                <p class="ml-4">- 60%ì—ì„œ ë§¤ìˆ˜: ìµœëŒ€ â†’ 33% ì´ìƒ ë°˜ë“±ì—ì„œ ë§¤ë„</p>
                <p class="ml-4">- 70%ì—ì„œ ë§¤ìˆ˜: ìµœëŒ€ â†’ 25% ì´ìƒ ë°˜ë“±ì—ì„œ ë§¤ë„</p>
                <div class="mt-4 pt-3 border-t-2 border-amber-300">
                    <p class="text-red-600 font-bold">âš ï¸ í•œ ë²ˆ ì²­ì‚°ë˜ë©´ í•´ë‹¹ ì¢…ëª©ì˜ ë§¤ë§¤ëŠ” ì¢…ë£Œí•©ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ API ì„¤ì • ==========
        const CLIENT_ID = '574140412573-n0jau2i3uph1v5p3hi9v004m44bnopq8.apps.googleusercontent.com';
        const API_KEY = '';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILE_NAME = 'samsihwak_extended_stocks.json';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let isSignedIn = false;
        let driveFileId = null;
        let tokenRefreshTimer = null; // í† í° ìë™ ê°±ì‹  íƒ€ì´ë¨¸

        // ========== ë°ì´í„° ê´€ë¦¬ ==========
        let stockDatabase = [];
        let currentSelectedIndex = -1;
        let draggedIndex = null;

        // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ
        const savedData = localStorage.getItem('samsihwakExtendedStocks');
        if (savedData) {
            stockDatabase = JSON.parse(savedData);
        }

        // ========== Google API ì´ˆê¸°í™” ==========
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                document.getElementById('googleSignInBtn').disabled = false;
            }
        }

        // ========== êµ¬ê¸€ ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ==========
        function handleAuthClick() {
            if (isSignedIn) {
                handleSignoutClick();
            } else {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        throw (resp);
                    }
                    
                    // í† í°ì„ localStorageì— ì €ì¥
                    localStorage.setItem('google_access_token_samsihwak', resp.access_token);
                    if (resp.expires_in) {
                        const expiryTime = Date.now() + (resp.expires_in * 1000);
                        localStorage.setItem('google_token_expiry_samsihwak', expiryTime.toString());
                        
                        // í† í° ìë™ ê°±ì‹  íƒ€ì´ë¨¸ ì„¤ì • (ë§Œë£Œ 5ë¶„ ì „ì— ê°±ì‹ )
                        setupTokenRefresh(resp.expires_in);
                    }
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    await loadFromGoogleDrive();
                };

                if (gapi.client.getToken() === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            }
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            
            // í† í° ê°±ì‹  íƒ€ì´ë¨¸ ì •ë¦¬
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
                tokenRefreshTimer = null;
            }
            
            // localStorageì—ì„œ í† í° ì‚­ì œ
            localStorage.removeItem('google_access_token_samsihwak');
            localStorage.removeItem('google_token_expiry_samsihwak');
            
            isSignedIn = false;
            updateSyncStatus('disconnected', 'ì—°ê²° ì•ˆë¨');
            document.getElementById('googleBtnText').textContent = 'êµ¬ê¸€ ë¡œê·¸ì¸';
            document.getElementById('lastSyncTime').textContent = '';
            document.getElementById('backupBtn').disabled = true;
            document.getElementById('loadBtn').disabled = true;
        }

        // ========== ì €ì¥ëœ í† í°ìœ¼ë¡œ ë¡œê·¸ì¸ ë³µì› ==========
        async function restoreLoginState() {
            const savedToken = localStorage.getItem('google_access_token_samsihwak');
            const tokenExpiry = localStorage.getItem('google_token_expiry_samsihwak');
            
            if (savedToken && tokenExpiry) {
                // í† í°ì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸
                if (Date.now() < parseInt(tokenExpiry)) {
                    // í† í°ì„ gapi í´ë¼ì´ì–¸íŠ¸ì— ì„¤ì •
                    gapi.client.setToken({
                        access_token: savedToken
                    });
                    
                    isSignedIn = true;
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    document.getElementById('googleBtnText').textContent = 'ë¡œê·¸ì•„ì›ƒ';
                    document.getElementById('backupBtn').disabled = false;
                    document.getElementById('loadBtn').disabled = false;
                    
                    // ë‚¨ì€ ì‹œê°„ ê³„ì‚°í•˜ì—¬ í† í° ìë™ ê°±ì‹  íƒ€ì´ë¨¸ ì„¤ì •
                    const remainingSeconds = Math.floor((parseInt(tokenExpiry) - Date.now()) / 1000);
                    setupTokenRefresh(remainingSeconds);
                    
                    // ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                    await loadFromGoogleDrive();
                } else {
                    // í† í°ì´ ë§Œë£Œë˜ì—ˆìœ¼ë©´ ì‚­ì œ
                    localStorage.removeItem('google_access_token_samsihwak');
                    localStorage.removeItem('google_token_expiry_samsihwak');
                }
            }
        }

        // ========== í† í° ìë™ ê°±ì‹  ì„¤ì • ==========
        function setupTokenRefresh(expiresInSeconds) {
            // ê¸°ì¡´ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì œê±°
            if (tokenRefreshTimer) {
                clearTimeout(tokenRefreshTimer);
            }
            
            // ë§Œë£Œ 5ë¶„ ì „ì— ê°±ì‹  (ìµœì†Œ 1ë¶„ ì „)
            const refreshTime = Math.max((expiresInSeconds - 300) * 1000, 60 * 1000);
            
            tokenRefreshTimer = setTimeout(async () => {
                if (isSignedIn && tokenClient) {
                    try {
                        // íŒì—… ì—†ì´ ìë™ ê°±ì‹  ì‹œë„
                        tokenClient.callback = async (resp) => {
                            if (resp.error === undefined) {
                                // í† í°ì„ localStorageì— ì €ì¥
                                localStorage.setItem('google_access_token_samsihwak', resp.access_token);
                                if (resp.expires_in) {
                                    const expiryTime = Date.now() + (resp.expires_in * 1000);
                                    localStorage.setItem('google_token_expiry_samsihwak', expiryTime.toString());
                                    
                                    // ë‹¤ì‹œ íƒ€ì´ë¨¸ ì„¤ì •
                                    setupTokenRefresh(resp.expires_in);
                                }
                                
                                gapi.client.setToken({
                                    access_token: resp.access_token
                                });
                                
                                console.log('í† í°ì´ ìë™ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            }
                        };
                        
                        tokenClient.requestAccessToken({prompt: ''});
                    } catch (err) {
                        console.error('í† í° ìë™ ê°±ì‹  ì‹¤íŒ¨:', err);
                    }
                }
            }, refreshTime);
        }

        // ========== ë™ê¸°í™” ìƒíƒœ í‘œì‹œ ==========
        function updateSyncStatus(status, text) {
            const statusEl = document.getElementById('syncStatus');
            const textEl = document.getElementById('statusText');
            statusEl.className = `sync-status ${status}`;
            textEl.textContent = text;
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeStr = now.toLocaleString('ko-KR');
            document.getElementById('lastSyncTime').textContent = `ë§ˆì§€ë§‰ ë™ê¸°í™”: ${timeStr}`;
        }

        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œ íŒŒì¼ ì°¾ê¸° ==========
        async function findDriveFile() {
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${FILE_NAME}' and trashed=false`,
                    spaces: 'drive',
                    fields: 'files(id, name)',
                });
                const files = response.result.files;
                if (files && files.length > 0) {
                    return files[0].id;
                }
                return null;
            } catch (err) {
                console.error('íŒŒì¼ ê²€ìƒ‰ ì˜¤ë¥˜:', err);
                return null;
            }
        }

        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° ==========
        async function loadFromGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            
            try {
                driveFileId = await findDriveFile();
                
                if (driveFileId) {
                    const response = await gapi.client.drive.files.get({
                        fileId: driveFileId,
                        alt: 'media',
                    });
                    
                    stockDatabase = JSON.parse(response.body);
                    localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                    renderStockList();
                    updateSyncStatus('connected', 'ì—°ê²°ë¨');
                    updateLastSyncTime();
                } else {
                    updateSyncStatus('connected', 'ì—°ê²°ë¨ (íŒŒì¼ ì—†ìŒ)');
                }
            } catch (err) {
                console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
            }
        }

        // ========== êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ì €ì¥ ==========
        async function saveToGoogleDrive() {
            if (!isSignedIn) return;
            
            updateSyncStatus('syncing', 'ì €ì¥ ì¤‘...');
            
            try {
                const data = JSON.stringify(stockDatabase, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                
                if (driveFileId) {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    await fetch(`https://www.googleapis.com/upload/drive/v3/files/${driveFileId}?uploadType=multipart`, {
                        method: 'PATCH',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                } else {
                    const metadata = {
                        name: FILE_NAME,
                        mimeType: 'application/json',
                    };
                    
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', blob);
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
                        body: form,
                    });
                    
                    const result = await response.json();
                    driveFileId = result.id;
                }
                
                updateSyncStatus('connected', 'ì—°ê²°ë¨');
                updateLastSyncTime();
            } catch (err) {
                console.error('ì €ì¥ ì˜¤ë¥˜:', err);
                updateSyncStatus('connected', 'ì—°ê²°ë¨ (ì €ì¥ ì‹¤íŒ¨)');
            }
        }

        // ========== ìˆ˜ë™ ë°±ì—… ==========
        async function manualBackup() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('í˜„ì¬ ë°ì´í„°ë¥¼ êµ¬ê¸€ ë“œë¼ì´ë¸Œì— ë°±ì—…í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await saveToGoogleDrive();
                alert('ë°±ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ========== ìˆ˜ë™ ë¶ˆëŸ¬ì˜¤ê¸° ==========
        async function manualLoad() {
            if (!isSignedIn) {
                alert('êµ¬ê¸€ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            if (confirm('êµ¬ê¸€ ë“œë¼ì´ë¸Œì—ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) {
                await loadFromGoogleDrive();
                alert('ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ========== í˜¸ê°€ë‹¨ìœ„ ê³„ì‚° ==========
        function getTickSize(price) {
            if (price < 2000) return 1;
            if (price < 5000) return 5;
            if (price < 20000) return 10;
            if (price < 50000) return 50;
            if (price < 200000) return 100;
            if (price < 500000) return 500;
            return 1000;
        }

        function adjustBuyPrice(price) {
            const tickSize = getTickSize(price);
            const adjusted = Math.ceil(price / tickSize) * tickSize;
            return { original: price, adjusted: adjusted };
        }

        function adjustSellPrice(price) {
            const tickSize = getTickSize(price);
            const adjusted = Math.floor(price / tickSize) * tickSize;
            return { original: price, adjusted: adjusted };
        }

        // ========== í¬ë§·íŒ… í•¨ìˆ˜ ==========
        function formatDateInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value.length > 6) value = value.substring(0, 6);
            input.value = value;
        }

        function formatInput(input) {
            let value = input.value.replace(/[^0-9]/g, '');
            if (value) {
                input.value = parseInt(value).toLocaleString('ko-KR');
            }
        }

        function formatPrice(price) {
            return Math.round(price).toLocaleString('ko-KR');
        }

        function formatPriceWithOriginal(adjusted, original) {
            const formattedAdjusted = formatPrice(adjusted);
            if (Math.abs(adjusted - original) > 0.01) {
                return `${formattedAdjusted}ì› <span class="text-xs text-gray-500">(${formatPrice(original)}ì›)</span>`;
            }
            return `${formattedAdjusted}ì›`;
        }

        function getNumericValue(elementId) {
            const value = document.getElementById(elementId).value.replace(/,/g, '');
            return value ? parseFloat(value) : null;
        }

        function calculateDDay(dateStr) {
            if (!dateStr || dateStr.length !== 6) return { text: '', days: 0 };
            
            try {
                const year = 2000 + parseInt(dateStr.substring(0, 2));
                const month = parseInt(dateStr.substring(2, 4)) - 1;
                const day = parseInt(dateStr.substring(4, 6));
                
                const targetDate = new Date(year, month, day);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const diffTime = today - targetDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                let text = '';
                if (diffDays === 0) text = 'D-Day';
                else if (diffDays > 0) text = `D+${diffDays}`;
                else text = `D${diffDays}`;
                
                return { text: text, days: diffDays };
            } catch (e) {
                return { text: '', days: 0 };
            }
        }

        // ========== ì´ˆê¸°í™” ==========
        function resetInputs() {
            document.getElementById('chartType').value = 'minute';
            document.getElementById('stockName').value = '';
            document.getElementById('highDate').value = '';
            document.getElementById('highPrice').value = '';
            document.getElementById('lowPrice').value = '';
            document.getElementById('bouncePrice').value = '';
            document.getElementById('buyPoints').innerHTML = '';
            document.getElementById('sellTitle').textContent = 'ğŸ’° ë§¤ë„ íƒ€ì ';
            document.getElementById('sellPoints').innerHTML = `
                <div class="text-center text-gray-500 py-8">
                    ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ë©´<br>ë§¤ë„ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤
                </div>
            `;
            currentSelectedIndex = -1;
            renderStockList();
        }

        // ========== ê³„ì‚° ==========
        function calculate() {
            const high = getNumericValue('highPrice');
            const low = getNumericValue('lowPrice');
            const bounce = getNumericValue('bouncePrice');

            if (high === null || low === null) {
                alert('ê³ ì ê³¼ ì €ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (high <= low) {
                alert('ê³ ì ì´ ì €ì ë³´ë‹¤ ë†’ì•„ì•¼ í•©ë‹ˆë‹¤!');
                return;
            }

            const diff = high - low;

            const buy40 = adjustBuyPrice(high - (diff * 0.382));
            const buy50 = adjustBuyPrice(high - (diff * 0.5));
            const buy60 = adjustBuyPrice(high - (diff * 0.6));
            const buy70 = adjustBuyPrice(high - (diff * 0.7));

            document.getElementById('buyPoints').innerHTML = `
                <div class="buy-box buy-40">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">40% ë§¤ìˆ˜ <span class="text-sm text-gray-600">38.2%</span></div>
                            <div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div>
                        </div>
                        <div class="text-2xl font-bold text-pink-600">${formatPriceWithOriginal(buy40.adjusted, buy40.original)}</div>
                    </div>
                </div>
                
                <div class="buy-box buy-50">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">50% ë§¤ìˆ˜</div>
                            <div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div>
                        </div>
                        <div class="text-2xl font-bold text-blue-600">${formatPriceWithOriginal(buy50.adjusted, buy50.original)}</div>
                    </div>
                </div>
                
                <div class="buy-box buy-60">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">60% ë§¤ìˆ˜</div>
                            <div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div>
                        </div>
                        <div class="text-2xl font-bold text-yellow-600">${formatPriceWithOriginal(buy60.adjusted, buy60.original)}</div>
                    </div>
                </div>
                
                <div class="buy-box buy-70">
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-lg">70% ë§¤ìˆ˜</div>
                            <div class="text-xs text-gray-500 mt-1">â‰ˆ ë§¤ìˆ˜ê°€</div>
                        </div>
                        <div class="text-2xl font-bold text-red-600">${formatPriceWithOriginal(buy70.adjusted, buy70.original)}</div>
                    </div>
                </div>
            `;

            if (bounce !== null && bounce < high) {
                const bounceRange = high - bounce;
                
                const sell25 = adjustSellPrice(bounce + (bounceRange * 0.25));
                const sell33 = adjustSellPrice(bounce + (bounceRange * 0.33));
                const sell50 = adjustSellPrice(bounce + (bounceRange * 0.50));
                const sell66 = adjustSellPrice(bounce + (bounceRange * 0.66));
                const sell75 = adjustSellPrice(bounce + (bounceRange * 0.75));

                const riseRate4050 = (((buy40.adjusted - buy50.adjusted) / buy50.adjusted) * 100).toFixed(2);
                
                document.getElementById('sellTitle').innerHTML = `ğŸ’° ë§¤ë„ íƒ€ì  <span class="text-base font-normal text-gray-600">(40-50 ìƒìŠ¹ë¥ : ${riseRate4050}%)</span>`;

                document.getElementById('sellPoints').innerHTML = `
                    <div class="space-y-3">
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">25% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell25.adjusted, sell25.original)}</div>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">33% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell33.adjusted, sell33.original)}</div>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">50% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell50.adjusted, sell50.original)}</div>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">66% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell66.adjusted, sell66.original)}</div>
                            </div>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg border-2 border-green-300">
                            <div class="flex justify-between items-center">
                                <div class="font-bold">75% ë°˜ë“±</div>
                                <div class="text-xl font-bold text-green-600">${formatPriceWithOriginal(sell75.adjusted, sell75.original)}</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                document.getElementById('sellTitle').textContent = 'ğŸ’° ë§¤ë„ íƒ€ì ';
                document.getElementById('sellPoints').innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        ë°˜ë“±ì €ì ì„ ì…ë ¥í•˜ë©´<br>ë§¤ë„ íƒ€ì ì´ í‘œì‹œë©ë‹ˆë‹¤
                    </div>
                `;
            }
        }

        // ========== ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ ==========
        async function addToList() {
            const chartType = document.getElementById('chartType').value;
            const stockName = document.getElementById('stockName').value;
            const highDate = document.getElementById('highDate').value;
            const high = getNumericValue('highPrice');
            const low = getNumericValue('lowPrice');
            const bounce = getNumericValue('bouncePrice');

            if (!stockName || high === null || low === null) {
                alert('ì¢…ëª©ëª…, ê³ ì , ì €ì ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            const stockData = {
                chartType: chartType,
                name: stockName,
                highDate: highDate || '',
                high: high,
                low: low,
                bounce: bounce,
                timestamp: new Date().toISOString()
            };

            // ê°™ì€ ì°¨íŠ¸íƒ€ì… ë‚´ì—ì„œë§Œ ì¤‘ë³µ ì²´í¬
            const existingIndex = stockDatabase.findIndex(stock => 
                stock.name === stockName && stock.chartType === chartType
            );
            
            if (existingIndex !== -1) {
                stockDatabase[existingIndex] = stockData;
                const chartTypeText = chartType === 'minute' ? 'ë¶„ë´‰' : 'ì¼ë´‰';
                alert(`"${stockName}" (${chartTypeText}) ì¢…ëª© ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            } else {
                stockDatabase.unshift(stockData);
                const chartTypeText = chartType === 'minute' ? 'ë¶„ë´‰' : 'ì¼ë´‰';
                alert(`"${stockName}" (${chartTypeText}) ì¢…ëª©ì´ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            }
            
            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
            await saveToGoogleDrive();
            renderStockList();
        }

        function renderStockList() {
            const minuteStocks = stockDatabase.filter(stock => stock.chartType === 'minute');
            const dailyStocks = stockDatabase.filter(stock => stock.chartType === 'daily');
            
            renderStockTable('minuteStockList', minuteStocks, 'minute');
            renderStockTable('dailyStockList', dailyStocks, 'daily');
        }

        function renderStockTable(elementId, stocks, chartType) {
            const listElement = document.getElementById(elementId);
            
            if (stocks.length === 0) {
                listElement.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        ì•„ì§ ì €ì¥ëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        "${chartType === 'minute' ? 'ë¶„ë´‰' : 'ì¼ë´‰'}" ì°¨íŠ¸ë¥¼ ì„ íƒí•˜ê³  "ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¢…ëª©ì„ ì €ì¥í•˜ì„¸ìš”.
                    </div>
                `;
                return;
            }

            listElement.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-xs">
                        <thead>
                            <tr class="bg-gradient-to-r ${chartType === 'minute' ? 'from-amber-100 to-yellow-100 border-amber-300' : 'from-blue-100 to-cyan-100 border-blue-300'} border-b-2">
                                <th class="p-2 text-left font-bold whitespace-nowrap">â‹®</th>
                                <th class="p-2 text-left font-bold whitespace-nowrap">ì¢…ëª©ëª…</th>
                                <th class="p-2 text-center font-bold text-pink-600 whitespace-nowrap">40%</th>
                                ${chartType === 'daily' ? '<th class="p-2 text-center font-bold text-gray-900 whitespace-nowrap">45%</th>' : ''}
                                <th class="p-2 text-center font-bold text-blue-600 whitespace-nowrap">50%</th>
                                ${chartType === 'daily' ? '<th class="p-2 text-center font-bold text-gray-900 whitespace-nowrap">55%</th>' : ''}
                                <th class="p-2 text-center font-bold text-yellow-600 whitespace-nowrap">60%</th>
                                ${chartType === 'daily' ? '<th class="p-2 text-center font-bold text-gray-900 whitespace-nowrap">65%</th>' : ''}
                                <th class="p-2 text-center font-bold text-red-600 whitespace-nowrap">70%</th>
                                <th class="p-2 text-center font-bold text-green-600 whitespace-nowrap">25%â†‘</th>
                                <th class="p-2 text-center font-bold text-green-600 whitespace-nowrap">33%â†‘</th>
                                <th class="p-2 text-center font-bold text-green-600 whitespace-nowrap">50%â†‘</th>
                                <th class="p-2 text-center font-bold text-green-600 whitespace-nowrap">75%â†‘</th>
                                <th class="p-2 text-center whitespace-nowrap">ê´€ë¦¬</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stocks.map((stock) => {
                                const globalIndex = stockDatabase.findIndex(s => s.name === stock.name && s.timestamp === stock.timestamp);
                                const selected = globalIndex === currentSelectedIndex ? 'bg-purple-100' : '';
                                
                                const diff = stock.high - stock.low;
                                const buy40 = adjustBuyPrice(stock.high - (diff * 0.382));
                                const buy45 = adjustBuyPrice(stock.high - (diff * 0.45));
                                const buy50 = adjustBuyPrice(stock.high - (diff * 0.5));
                                const buy55 = adjustBuyPrice(stock.high - (diff * 0.55));
                                const buy60 = adjustBuyPrice(stock.high - (diff * 0.6));
                                const buy65 = adjustBuyPrice(stock.high - (diff * 0.65));
                                const buy70 = adjustBuyPrice(stock.high - (diff * 0.7));
                                
                                let sell25 = '-', sell33 = '-', sell50 = '-', sell75 = '-';
                                if (stock.bounce !== null && stock.bounce !== undefined) {
                                    const bounceRange = stock.high - stock.bounce;
                                    sell25 = formatPrice(adjustSellPrice(stock.bounce + (bounceRange * 0.25)).adjusted);
                                    sell33 = formatPrice(adjustSellPrice(stock.bounce + (bounceRange * 0.33)).adjusted);
                                    sell50 = formatPrice(adjustSellPrice(stock.bounce + (bounceRange * 0.50)).adjusted);
                                    sell75 = formatPrice(adjustSellPrice(stock.bounce + (bounceRange * 0.75)).adjusted);
                                }
                                
                                const dday = calculateDDay(stock.highDate);
                                let ddayBadge = '';
                                if (dday.text) {
                                    let badgeClass = 'd-day-badge';
                                    // ë¶„ë´‰ ì¢…ëª©ì˜ ê²½ìš°
                                    if (chartType === 'minute' && dday.days > 0) {
                                        if (dday.days >= 30) {
                                            badgeClass += ' danger'; // D+30 ì´ìƒ: ë¹¨ê°„ìƒ‰
                                        } else if (dday.days >= 14) {
                                            badgeClass += ' warning'; // D+14~29: ë…¸ë€ìƒ‰
                                        }
                                    }
                                    // ì¼ë´‰ ì¢…ëª©ì˜ ê²½ìš°
                                    else if (chartType === 'daily' && dday.days > 0) {
                                        if (dday.days >= 80) {
                                            badgeClass += ' danger'; // D+80 ì´ìƒ: ë¹¨ê°„ìƒ‰
                                        } else if (dday.days >= 60) {
                                            badgeClass += ' warning'; // D+60~79: ë…¸ë€ìƒ‰
                                        }
                                    }
                                    ddayBadge = `<span class="${badgeClass}">${dday.text}</span>`;
                                }
                                
                                // 40%ì™€ 50% ë§¤ìˆ˜ê°€ ì‚¬ì´ì˜ ìƒìŠ¹ë¥  ê³„ì‚°
                                const riseRate = (((buy40.adjusted - buy50.adjusted) / buy50.adjusted) * 100).toFixed(2);
                                const riseRateBadge = `<span class="rise-rate-badge">${riseRate}%</span>`;
                                
                                return `
                                    <tr class="${selected} ${chartType === 'minute' ? 'hover:bg-amber-50' : 'hover:bg-blue-50'} cursor-pointer border-b transition-colors whitespace-nowrap" 
                                        draggable="true"
                                        ondragstart="handleDragStart(event, ${globalIndex})"
                                        ondragover="handleDragOver(event)"
                                        ondrop="handleDrop(event, ${globalIndex})"
                                        ondragend="handleDragEnd(event)"
                                        onclick="loadStock(${globalIndex})">
                                        <td class="drag-handle" onclick="event.stopPropagation()">â‹®â‹®</td>
                                        <td class="p-2 font-bold">${stock.name}${ddayBadge}${riseRateBadge}</td>
                                        <td class="p-2 text-center text-pink-600 font-semibold">${formatPrice(buy40.adjusted)}</td>
                                        ${chartType === 'daily' ? `<td class="p-2 text-center text-gray-900 font-semibold">${formatPrice(buy45.adjusted)}</td>` : ''}
                                        <td class="p-2 text-center text-blue-600 font-semibold">${formatPrice(buy50.adjusted)}</td>
                                        ${chartType === 'daily' ? `<td class="p-2 text-center text-gray-900 font-semibold">${formatPrice(buy55.adjusted)}</td>` : ''}
                                        <td class="p-2 text-center text-yellow-600 font-semibold">${formatPrice(buy60.adjusted)}</td>
                                        ${chartType === 'daily' ? `<td class="p-2 text-center text-gray-900 font-semibold">${formatPrice(buy65.adjusted)}</td>` : ''}
                                        <td class="p-2 text-center text-red-600 font-semibold">${formatPrice(buy70.adjusted)}</td>
                                        <td class="p-2 text-center text-green-600 font-semibold">${sell25}</td>
                                        <td class="p-2 text-center text-green-600 font-semibold">${sell33}</td>
                                        <td class="p-2 text-center text-green-600 font-semibold">${sell50}</td>
                                        <td class="p-2 text-center text-green-600 font-semibold">${sell75}</td>
                                        <td class="p-2 text-center">
                                            <button class="delete-btn" onclick="deleteStock(${globalIndex}, event)">ì‚­ì œ</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function handleDragStart(e, index) {
            draggedIndex = index;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        async function handleDrop(e, targetIndex) {
            e.preventDefault();
            e.stopPropagation();
            
            if (draggedIndex === null || draggedIndex === targetIndex) {
                return false;
            }

            const draggedItem = stockDatabase[draggedIndex];
            stockDatabase.splice(draggedIndex, 1);
            stockDatabase.splice(targetIndex, 0, draggedItem);

            if (currentSelectedIndex === draggedIndex) {
                currentSelectedIndex = targetIndex;
            } else if (draggedIndex < currentSelectedIndex && targetIndex >= currentSelectedIndex) {
                currentSelectedIndex--;
            } else if (draggedIndex > currentSelectedIndex && targetIndex <= currentSelectedIndex) {
                currentSelectedIndex++;
            }

            localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
            await saveToGoogleDrive();
            renderStockList();
            
            return false;
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedIndex = null;
        }

        function loadStock(index) {
            currentSelectedIndex = index;
            const stock = stockDatabase[index];
            
            document.getElementById('chartType').value = stock.chartType || 'minute';
            document.getElementById('stockName').value = stock.name;
            document.getElementById('highDate').value = stock.highDate || '';
            document.getElementById('highPrice').value = stock.high.toLocaleString('ko-KR');
            document.getElementById('lowPrice').value = stock.low.toLocaleString('ko-KR');
            document.getElementById('bouncePrice').value = stock.bounce !== null ? stock.bounce.toLocaleString('ko-KR') : '';
            
            calculate();
            renderStockList();
        }

        async function deleteStock(index, event) {
            event.stopPropagation();
            
            const stock = stockDatabase[index];
            if (confirm(`"${stock.name}" ì¢…ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                stockDatabase.splice(index, 1);
                localStorage.setItem('samsihwakExtendedStocks', JSON.stringify(stockDatabase));
                
                if (currentSelectedIndex === index) {
                    currentSelectedIndex = -1;
                } else if (currentSelectedIndex > index) {
                    currentSelectedIndex--;
                }
                
                await saveToGoogleDrive();
                renderStockList();
            }
        }

        // ========== í˜ì´ì§€ ë¡œë“œ ==========
        window.onload = function() {
            renderStockList();
            gapiLoaded();
            gisLoaded();
            
            // êµ¬ê¸€ API ì´ˆê¸°í™” ëŒ€ê¸° í›„ ë¡œê·¸ì¸ ìƒíƒœ ë³µì›
            const waitForInit = setInterval(async () => {
                if (gapiInited && gisInited) {
                    clearInterval(waitForInit);
                    await restoreLoginState();
                }
            }, 100);
        };
    </script>
</body>
</html>